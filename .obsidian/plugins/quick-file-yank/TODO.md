# quick-file-yank 插件 TODO

## 1. 插件目标与行为概述

- **主要目标**：提供类似「快速切换器（Quick Switcher）」的界面，从当前库中快速选择一个文件，并一键将该文件的**完整内容**复制到系统剪贴板。
- **触发方式**：仅通过命令面板（Command Palette）触发一个指令（后续可扩展为热键）。
- **适用场景**：在 Obsidian 中快速将某个笔记的内容复制到外部应用（IM、文档编辑器、浏览器等）。

## 2. 功能需求拆分

### 2.1 命令面板集成

- **注册命令**：
  - 在 `manifest.json` 中保持现有 `id`，将功能逻辑放在 `main.js` 内实现新的命令。
  - 在 `main.js` 中通过 `this.addCommand` 新增命令：
    - **id**：`quick-file-yank`
    - **name**：`Quick File Yank`
    - **callback / checkCallback**：打开文件选择界面并在选择后执行复制。
- **命令行为**：
  - 从任意上下文（编辑态/预览态/设置界面等）执行命令，能正常弹出文件选择界面。

### 2.2 文件选择（类似 Quick Switcher）

- **文件数据源**：
  - 使用 `this.app.vault.getAllLoadedFiles()` 或等效 API，过滤出 `TFile` 类型的 Markdown / 文本文件。
  - 可选：排除某些目录（如 `.obsidian/`）或资源类型（如图片、PDF），暂定只复制文本类笔记内容。
- **界面形式**：
  - 使用 Obsidian 提供的 `SuggestModal` / `FuzzySuggestModal`（根据 API 版本选择）实现：
    - 顶部输入框用于模糊搜索文件名（与 Quick Switcher 行为一致或类似）。
    - 下方列表展示匹配文件，显示至少：文件名；可选：所在路径。
  - 支持键盘操作：
    - 上下方向键移动选择。
    - `Enter` 确认当前选中项。
    - `Esc` 取消并关闭。
- **空结果处理**：
  - 如果当前库无可用文件（或全部被过滤掉），直接给出 `Notice` 提示「没有可复制的文件」。

### 2.3 复制文件内容到系统剪贴板

- **内容获取**：
  - 选择某个 `TFile` 后，使用 `this.app.vault.read(file)` 异步读取文件内容。
  - 默认复制 **原始 Markdown 文本**（不进行格式转换）。
- **复制到剪贴板**：
  - 优先使用 Obsidian 提供的剪贴板 API（如有），否则使用 `navigator.clipboard.writeText` 等浏览器 API。
  - 需要考虑桌面端 / 移动端的权限限制：
    - 复制失败时给出友好 `Notice` 提示，并在开发者控制台输出详细错误。
- **提示反馈**：
  - 复制成功：展示 `Notice`，内容类似：
    - `已复制 "<文件名>" 的内容到剪贴板`
  - 复制失败：展示 `Notice`：
    - `复制失败，请查看控制台日志`

## 3. 非功能性需求

- **性能**：
  - 文件列表获取与模糊匹配应在本地完成，不阻塞主线程太久。
  - 对于超大型库，如文件数过多，可考虑简单缓存文件列表（本版本先不做缓存，视实际体验再优化）。
- **兼容性**：
  - 参考现有 `manifest.json` 的 `minAppVersion`，保持在 1.5.8+ 环境正常工作。
  - 只依赖 Obsidian 官方 API 和浏览器标准 API，不引入外部打包工具。
- **错误处理**：
  - 任何读取文件或复制剪贴板失败的场景，都应：
    - 不崩溃插件本身。
    - 给用户清晰的错误提示（`Notice`）。

## 4. 实现步骤（开发任务清单）

### 4.1 基础结构与命令注册

- [ ] 在 `main.js` 中新增 `QuickFileYankPlugin` 相关逻辑（可在现有 `MyPlugin` 中直接扩展，或重命名为更贴切的类名）。
- [ ] 使用 `this.addCommand` 注册 `quick-file-yank` 命令，命令名显示为 `Quick File Yank`。
- [ ] 确认命令可以在命令面板中正常搜索并执行。

### 4.2 文件选择界面

- [ ] 在 `main.js` 中引入并使用 `FuzzySuggestModal`（或等效类）。
- [ ] 封装一个 `QuickFileYankModal` 类：
  - [ ] 在构造函数中接收 `app` 实例。
  - [ ] 实现获取文件列表的方法（过滤出需展示的文件类型）。
  - [ ] 实现模糊搜索展示逻辑（显示文件名和路径）。
  - [ ] 在用户确认选择后回调插件逻辑（触发读取与复制）。

### 4.3 读取文件与复制剪贴板

- [ ] 在插件主类中实现 `yankFile(file: TFile)` 方法（即传入文件，执行「读取 + 复制」的完整流程）。
- [ ] 使用 `this.app.vault.read(file)` 异步读取文件内容。
- [ ] 使用剪贴板 API 将内容复制到系统剪贴板：
  - [ ] 优先尝试 Obsidian 内置封装（若有）。
  - [ ] 退而求其次使用 `navigator.clipboard.writeText`。
  - [ ] 为可能的失败情况添加 `try/catch`，并做错误提示。
- [ ] 复制成功后，显示带文件名的成功提示 `Notice`。

### 4.4 配置与可选增强（后续可扩展）

- [ ] 在设置面板中增加简单选项（可选）：
  - [ ] 是否只显示 Markdown 文件（默认是）。
  - [ ] 是否包括特定目录 / 排除特定目录。
- [ ] 允许用户为 `quick-file-yank` 命令绑定快捷键（通过 Obsidian 自身「热键」设置页完成，本插件无需额外代码，但需在文档中说明）。

## 5. 测试清单

- [ ] 在小型库中测试：选择几个普通笔记，确认内容完整复制且无截断。
- [ ] 在包含非 Markdown 文件（图片、PDF等）的库中测试：确认这些文件不会出现在选择列表中（或出现时行为明确）。
- [ ] 在桌面端（Windows/macOS）测试剪贴板复制是否稳定。
- [ ] 在命令从不同上下文触发时测试（笔记编辑页 / 预览页 / 设置页）：
  - [ ] 都能正常弹出选择界面。
  - [ ] 取消时不发生异常。

